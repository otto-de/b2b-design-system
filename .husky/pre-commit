#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running npm security audit..."


npm run audit

AUDIT_EXIT_CODE=$?

if [ $AUDIT_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå COMMIT BLOCKED: npm audit found HIGH or CRITICAL vulnerabilities"
  echo ""
  echo "Please fix the vulnerabilities before committing:"
  echo "  1. Review the audit report above"
  echo "  2. Run 'npm audit fix' to auto-fix (if available)"
  echo "  3. For manual fixes, update package versions in package.json"
  echo "  4. Known allowlisted advisories are defined in audit-ci.jsonc (BLA-2056)"
  echo "  5. Re-run 'npm run audit' to verify fixes"
  echo ""
  echo "Note: MODERATE vulnerabilities are allowed but should be reviewed."
  echo ""
  exit 1
fi

echo "‚úÖ Security audit passed - no HIGH or CRITICAL vulnerabilities found"
echo ""

npx lint-staged